<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·šä¸ŠèŠå¤©å®¤</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { 
            getFirestore,
            collection,
            addDoc,
            onSnapshot,
            query,
            orderBy,
            serverTimestamp,
            doc,
            setDoc,
            getDoc,
            updateDoc,
            deleteDoc,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        // ä½ çš„Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBx-TGj56ULPupKwP1YipgQOgyBqwSAnos",
            authDomain: "chatroom-89cc9.firebaseapp.com",
            projectId: "chatroom-89cc9",
            storageBucket: "chatroom-89cc9.firebasestorage.app",
            messagingSenderId: "631226685830",
            appId: "1:631226685830:web:e3d3e0ed3202ff96d6b407",
            measurementId: "G-BEMTWM3XD5"
        };

        // åˆå§‹åŒ–Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // å…¨åŸŸè®Šæ•¸
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebase = {
            auth,
            db,
            signInAnonymously,
            onAuthStateChanged,
            signOut,
            collection,
            addDoc,
            onSnapshot,
            query,
            orderBy,
            serverTimestamp,
            doc,
            setDoc,
            getDoc,
            updateDoc,
            deleteDoc,
            writeBatch
        };
    </script>
</head>
<body>
    <!-- åŠ è¼‰ç•«é¢ -->
    <div id="loading" class="screen">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>è¼‰å…¥ä¸­...</p>
        </div>
    </div>

    <!-- ç™»å…¥ç•«é¢ -->
    <div id="login-screen" class="screen" style="display: none;">
        <div class="login-container">
            <h1 class="app-title"><span id="app-name">ç·šä¸ŠèŠå¤©å®¤</span></h1>
            <div class="login-steps">
                <!-- æ­¥é©Ÿ1: é¸æ“‡å‹•ç‰© -->
                <div id="step1" class="login-step active">
                    <p class="step-description">è«‹é¸æ“‡ 3 å€‹å‹•ç‰©ä½œç‚ºæ‚¨çš„ã€Œç™»å…¥ IDã€</p>
                    
                    <div class="animal-slots">
                        <div class="animal-slot" data-index="0" onclick="removeAnimal(0)">
                            <span class="placeholder">?</span>
                            <div class="slot-number">1</div>
                        </div>
                        <div class="animal-slot" data-index="1" onclick="removeAnimal(1)">
                            <span class="placeholder">?</span>
                            <div class="slot-number">2</div>
                        </div>
                        <div class="animal-slot" data-index="2" onclick="removeAnimal(2)">
                            <span class="placeholder">?</span>
                            <div class="slot-number">3</div>
                        </div>
                    </div>

                    <div class="animal-grid">
                        <!-- å‹•ç‰©åœ–ç¤ºæœƒç”±JSå‹•æ…‹ç”Ÿæˆ -->
                    </div>

                    <div class="step-actions">
                        <button onclick="goToStep(2)" id="next-btn" disabled class="btn-primary">
                            ä¸‹ä¸€æ­¥
                        </button>
                    </div>
                </div>

                <!-- æ­¥é©Ÿ2: è¼¸å…¥PINå’Œåç¨± -->
                <div id="step2" class="login-step">
                    <p class="step-description">è¼¸å…¥ PIN ç¢¼èˆ‡æš±ç¨±</p>
                    
                    <div class="selected-animals-display">
                        <span id="selected-animals-preview"></span>
                    </div>

                    <form id="login-form" onsubmit="handleLogin(event)">
                        <div class="form-group">
                            <label>PIN ç¢¼ (4-8ä½æ•¸å­—)</label>
                            <input type="text" id="pin-input" 
                                   placeholder="è¼¸å…¥ PIN ç¢¼" 
                                   maxlength="8"
                                   oninput="this.value = this.value.replace(/\D/g,'').slice(0,8)">
                        </div>

                        <div class="form-group">
                            <label>æš±ç¨± (é¡¯ç¤ºåç¨±)</label>
                            <input type="text" id="name-input" 
                                   placeholder="æ€éº¼ç¨±å‘¼æ‚¨ï¼Ÿ">
                        </div>

                        <div id="login-error" class="error-message" style="display: none;"></div>

                        <div class="step-actions">
                            <button type="button" onclick="goToStep(1)" class="btn-secondary">
                                é‡é¸
                            </button>
                            <button type="submit" id="login-btn" class="btn-primary">
                                <span>é€²å…¥èŠå¤©å®¤</span>
                                <i class="fas fa-sign-in-alt"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- èŠå¤©å®¤ç•«é¢ -->
    <div id="chat-screen" class="screen" style="display: none;">
        <div class="chat-container">
            <!-- å´é‚Šæ¬„ -->
            <div id="sidebar" class="sidebar">
                <div class="sidebar-header">
                    <h2 id="sidebar-app-name">ç·šä¸ŠèŠå¤©å®¤</h2>
                    <div class="sidebar-controls">
                        <button onclick="toggleSidebarView()" class="icon-btn" title="åˆ‡æ›æª¢è¦–">
                            <i id="sidebar-toggle-icon" class="fas fa-users"></i>
                        </button>
                        <button onclick="toggleMobileMenu()" class="icon-btn mobile-only">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- é »é“åˆ—è¡¨ -->
                <div id="channels-view" class="sidebar-content">
                    <div class="sidebar-section">
                        <h3><i class="fas fa-hashtag"></i> é »é“</h3>
                        <div id="channels-list" class="channel-list">
                            <!-- é »é“åˆ—è¡¨å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>

                <!-- æˆå“¡åˆ—è¡¨ -->
                <div id="members-view" class="sidebar-content" style="display: none;">
                    <div class="sidebar-section">
                        <h3><i class="fas fa-user-friends"></i> ç·šä¸Šæˆå“¡</h3>
                        <div id="members-list" class="member-list">
                            <!-- æˆå“¡åˆ—è¡¨å‹•æ…‹ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>

                <!-- ä½¿ç”¨è€…è³‡è¨Š -->
                <div class="user-info">
                    <div class="user-avatar">
                        <div id="user-avatar" class="avatar">
                            <span id="user-avatar-emoji">ğŸ±</span>
                        </div>
                        <div class="user-details">
                            <strong id="user-name">ä½¿ç”¨è€…</strong>
                            <small id="user-id">ID: ...</small>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button onclick="showAdminPanel()" class="btn-small">
                            <i class="fas fa-cog"></i> è¨­å®š
                        </button>
                        <button onclick="handleLogout()" class="btn-small btn-danger">
                            <i class="fas fa-sign-out-alt"></i> ç™»å‡º
                        </button>
                    </div>
                </div>
            </div>

            <!-- ä¸»è¦èŠå¤©å€åŸŸ -->
            <div class="main-chat">
                <!-- èŠå¤©å®¤æ¨™é¡Œåˆ— -->
                <div class="chat-header">
                    <button onclick="toggleMobileMenu()" class="icon-btn mobile-only">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="channel-info">
                        <span id="current-channel-emoji" class="channel-emoji">ğŸ’¬</span>
                        <h3 id="current-channel-name">ä¸€èˆ¬é–’èŠ</h3>
                    </div>
                </div>

                <!-- è¨Šæ¯å€åŸŸ -->
                <div id="messages-container" class="messages-container">
                    <!-- è¨Šæ¯å‹•æ…‹ç”Ÿæˆ -->
                </div>

                <!-- è¨Šæ¯è¼¸å…¥ -->
                <div class="message-input-area">
                    <form id="message-form" onsubmit="sendMessage(event)">
                        <input type="text" 
                               id="message-input" 
                               placeholder="è¼¸å…¥è¨Šæ¯..."
                               autocomplete="off">
                        <button type="submit" id="send-btn" class="btn-primary">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ç®¡ç†é¢æ¿ -->
    <div id="admin-panel" class="modal-overlay" style="display: none;">
        <div class="admin-panel">
            <div class="admin-header">
                <h2><i class="fas fa-cog"></i> æ§åˆ¶å°</h2>
                <button onclick="hideAdminPanel()" class="icon-btn close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="admin-tabs">
                <button onclick="switchAdminTab('settings')" class="admin-tab active">
                    <i class="fas fa-user"></i> å€‹äººè¨­å®š
                </button>
                <button onclick="switchAdminTab('system')" class="admin-tab">
                    <i class="fas fa-cogs"></i> ç³»çµ±è¨­å®š
                </button>
                <button onclick="switchAdminTab('channels')" class="admin-tab">
                    <i class="fas fa-hashtag"></i> é »é“ç®¡ç†
                </button>
                <button onclick="switchAdminTab('users')" class="admin-tab">
                    <i class="fas fa-users"></i> æˆå“¡ç®¡ç†
                </button>
            </div>

            <div class="admin-content">
                <!-- å€‹äººè¨­å®š -->
                <div id="settings-tab" class="admin-tab-content active">
                    <h3>å€‹äººå¸³æˆ¶è¨­å®š</h3>
                    <!-- å…§å®¹ç”±JSå‹•æ…‹ç”Ÿæˆ -->
                </div>

                <!-- ç³»çµ±è¨­å®š -->
                <div id="system-tab" class="admin-tab-content">
                    <h3>ç³»çµ±è¨­å®š</h3>
                    <!-- å…§å®¹ç”±JSå‹•æ…‹ç”Ÿæˆ -->
                </div>

                <!-- é »é“ç®¡ç† -->
                <div id="channels-tab" class="admin-tab-content">
                    <h3>é »é“ç®¡ç†</h3>
                    <!-- å…§å®¹ç”±JSå‹•æ…‹ç”Ÿæˆ -->
                </div>

                <!-- æˆå“¡ç®¡ç† -->
                <div id="users-tab" class="admin-tab-content">
                    <h3>æˆå“¡åˆ—è¡¨</h3>
                    <!-- å…§å®¹ç”±JSå‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ç¢ºèªå°è©±æ¡† -->
    <div id="confirm-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 id="confirm-title">ç¢ºèªæ“ä½œ</h3>
            </div>
            <div class="modal-body">
                <p id="confirm-message">ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            </div>
            <div class="modal-footer">
                <button onclick="confirmCancel()" class="btn-secondary">å–æ¶ˆ</button>
                <button onclick="confirmAction()" id="confirm-action-btn" class="btn-primary">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥å°è©±æ¡† -->
    <div id="alert-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-body text-center">
                <i id="alert-icon" class="fas fa-exclamation-circle"></i>
                <p id="alert-message"></p>
            </div>
            <div class="modal-footer">
                <button onclick="hideAlert()" class="btn-primary">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <!-- è¢«è¸¢å‡ºç•«é¢ -->
    <div id="kicked-screen" class="screen" style="display: none;">
        <div class="kicked-container">
            <div class="kicked-icon">
                <i class="fas fa-clock"></i>
            </div>
            <h1>æ‚¨å·²è¢«æš«æ™‚è¸¢å‡º</h1>
            <p>ç®¡ç†å“¡å·²é™åˆ¶æ‚¨çš„è¨ªå•æ¬Šé™</p>
            <div class="kick-time" id="kick-until"></div>
            <button onclick="handleKickedLogout()" class="btn-primary">
                è¿”å›é¦–é 
            </button>
        </div>
    </div>

    <!-- å¼•å…¥JavaScript -->
    <script src="app.js"></script>
</body>
</html>
