<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç·šä¸ŠèŠå¤©å®¤</title>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Firebase SDK (æ¨¡çµ„ç‰ˆ) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp, writeBatch, where } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBx-TGj56ULPupKwP1YipgQOgyBqwSAnos",
      authDomain: "chatroom-89cc9.firebaseapp.com",
      projectId: "chatroom-89cc9",
      storageBucket: "chatroom-89cc9.firebasestorage.app",
      messagingSenderId: "631226685830",
      appId: "1:631226685830:web:e3d3e0ed3202ff96d6b407",
      measurementId: "G-BEMTWM3XD5"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = "chatroom-89cc9"; // å›ºå®šä½ çš„ project ID ç•¶ä½œ appId

    // å…¨åŸŸè®Šæ•¸
    let currentUser = null;
    let userProfile = null;
    let animalId = localStorage.getItem(`chat_app_animal_id_${appId}`);
    let channels = [];
    let currentChannelId = "general";
    let allUsers = {}; // key: animalId â†’ user data

    const ALL_ANIMALS = ["ğŸ¶","ğŸ±","ğŸ­","ğŸ¹","ğŸ°","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¨","ğŸ¯","ğŸ¦","ğŸ®","ğŸ·","ğŸ¸","ğŸµ","ğŸ”","ğŸ§","ğŸ¦","ğŸ¦„","ğŸ™"];

    // ==================== å·¥å…·å‡½å¼ ====================
    function $(selector) { return document.querySelector(selector); }
    function $$(selector) { return Array.from(document.querySelectorAll(selector)); }

    function showScreen(id) {
      $$('.screen').forEach(s => s.classList.add('hidden'));
      $(`#${id}`).classList.remove('hidden');
    }

    function formatTime(ts) {
      if (!ts) return '';
      return new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }

    function createAvatar(url, fallback) {
      const div = document.createElement('div');
      div.className = "w-10 h-10 rounded-full bg-gradient-to-br from-gray-700 to-gray-600 flex items-center justify-center text-xl border border-white/10";
      if (url) {
        const img = document.createElement('img');
        img.src = url;
        img.className = "w-full h-full rounded-full object-cover";
        img.onerror = () => div.innerHTML = fallback;
        div.appendChild(img);
      } else {
        div.textContent = fallback;
      }
      return div;
    }

    // ==================== ç™»å…¥ç›¸é—œ ====================
    async function login(animals, pin, name = '') {
      const targetId = animals.join('');
      try {
        if (!auth.currentUser) await signInAnonymously(auth);

        const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', targetId);
        const snap = await getDoc(userRef);

        if (snap.exists()) {
          const data = snap.data();
          if (data.pin !== pin) throw new Error("PIN éŒ¯èª¤");
          if (data.kickedUntil && data.kickedUntil > Date.now()) {
            throw new Error(`å·²è¢«è¸¢å‡ºè‡³ ${new Date(data.kickedUntil).toLocaleString()}`);
          }
          await updateDoc(userRef, { uid: auth.currentUser.uid, lastSeenAt: serverTimestamp() });
        } else {
          if (!name.trim()) throw new Error("é¦–æ¬¡ç™»å…¥è«‹è¼¸å…¥æš±ç¨±");
          const isFirst = !(await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'system', 'config'))).exists();
          await setDoc(userRef, {
            animalId: targetId,
            animals,
            pin,
            name: name.trim(),
            avatarUrl: "",
            role: isFirst ? 'admin' : 'user',
            uid: auth.currentUser.uid,
            createdAt: serverTimestamp(),
            lastSeenAt: serverTimestamp()
          });
          if (isFirst) {
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'system', 'config'), { initialized: true });
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'channels', 'general'), {
              name: "ğŸ’¬ ä¸€èˆ¬é–’èŠ", emoji: "ğŸ’¬", createdAt: serverTimestamp()
            });
          }
        }
        localStorage.setItem(`chat_app_animal_id_${appId}`, targetId);
        location.reload(); // ç°¡å–®é‡æ•´é€²å…¥èŠå¤©å®¤
      } catch (e) {
        alert(e.message);
      }
    }

    // ==================== åˆå§‹åŒ– ====================
    onAuthStateChanged(auth, async (user) => {
      if (user) currentUser = user;
      if (animalId && currentUser) {
        const profileRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', animalId);
        onSnapshot(profileRef, (snap) => {
          if (snap.exists()) {
            const data = snap.data();
            if (data.kickedUntil && data.kickedUntil > Date.now()) {
              showScreen('kicked-screen');
              $('#kicked-until').textContent = new Date(data.kickedUntil).toLocaleString();
              return;
            }
            userProfile = { id: animalId, ...data };
            initChatRoom();
          } else {
            localStorage.removeItem(`chat_app_animal_id_${appId}`);
            showScreen('login-screen');
          }
        });
      } else {
        showScreen('login-screen');
      }
    });

    // ==================== èŠå¤©å®¤ä¸»é‚è¼¯ ====================
    function initChatRoom() {
      showScreen('chat-screen');

      // é »é“åˆ—è¡¨
      onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'channels'), orderBy('createdAt')), (snap) => {
        channels = snap.docs.map(d => ({id: d.id, ...d.data()}));
        renderChannels();
        if (!channels.find(c => c.id === currentChannelId)) currentChannelId = channels[0]?.id || 'general';
        renderMessages();
      });

      // æ‰€æœ‰ä½¿ç”¨è€…ï¼ˆç”¨æ–¼å³æ™‚é ­åƒã€åç¨±ï¼‰
      onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snap) => {
        allUsers = {};
        snap.forEach(d => allUsers[d.id] = {id: d.id, ...d.data()});
        renderMembers();
        renderMessages(); // æ›´æ–°åç¨±/é ­åƒ
      });

      // è¨Šæ¯
      function renderMessages() {
        const container = $('#messages');
        container.innerHTML = '';
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'messages'),
                        where('channelId', '==', currentChannelId),
                        orderBy('timestamp'));
        onSnapshot(q, (snap) => {
          container.innerHTML = '';
          snap.forEach(doc => {
            const msg = {id: doc.id, ...doc.data()};
            const sender = allUsers[msg.senderId] || {name: msg.senderName, avatarUrl: msg.senderAvatarUrl};
            const isMe = msg.senderId === userProfile.id;
            const canDelete = isMe || userProfile.role === 'admin';

            const bubble = document.createElement('div');
            bubble.className = `flex gap-3 mb-4 ${isMe ? 'flex-row-reverse' : ''}`;

            const avatar = createAvatar(sender.avatarUrl, msg.senderAnimal || sender.animals?.[0]);
            bubble.appendChild(avatar);

            const content = document.createElement('div');
            content.className = `max-w-[70%] ${isMe ? 'items-end' : 'items-start'} flex flex-col`;

            const header = document.createElement('div');
            header.className = "flex items-center gap-2 mb-1";
            header.innerHTML = `<span class="text-sm font-bold">${sender.name || 'æœªçŸ¥'}</span><span class="text-xs opacity-60">${formatTime(msg.timestamp)}</span>`;
            content.appendChild(header);

            const textDiv = document.createElement('div');
            textDiv.className = `p-3 rounded-2xl ${isMe ? 'bg-fuchsia-600 text-white rounded-tr-none' : 'bg-gray-800 text-gray-200 rounded-tl-none'}`;
            textDiv.textContent = msg.text;
            if (canDelete) {
              const delBtn = document.createElement('button');
              delBtn.innerHTML = '<i data-lucide="x" class="w-4 h-4"></i>';
              delBtn.className = "absolute -top-2 -right-2 bg-red-600 text-white p-1 rounded-full opacity-0 group-hover:opacity-100";
              delBtn.onclick = () => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'messages', msg.id));
              textDiv.className += " relative group";
              textDiv.appendChild(delBtn);
            }
            content.appendChild(textDiv);
            bubble.appendChild(content);
            container.appendChild(bubble);
            lucide.createIcons();
          });
          container.scrollTop = container.scrollHeight;
        });
      }

      // ç™¼é€è¨Šæ¯
      $('#send-btn').onclick = async () => {
        const input = $('#message-input');
        const text = input.value.trim();
        if (!text) return;
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
          text,
          channelId: currentChannelId,
          senderId: userProfile.id,
          senderName: userProfile.name,
          senderAvatarUrl: userProfile.avatarUrl || "",
          senderAnimal: userProfile.animals[0],
          timestamp: Date.now()
        });
        input.value = '';
      };

      $('#message-input').addEventListener('keypress', e => { if (e.key === 'Enter') $('#send-btn').click(); });
    }

    function renderChannels() {
      const list = $('#channel-list');
      list.innerHTML = '';
      channels.forEach(ch => {
        const btn = document.createElement('button');
        btn.className = `w-full text-left px-4 py-3 rounded-xl flex items-center gap-3 ${ch.id === currentChannelId ? 'bg-fuchsia-600 text-white' : 'text-gray-400 hover:bg-white/5'}`;
        btn.innerHTML = `<span class="text-lg">${ch.emoji}</span><span>${ch.name}</span>`;
        btn.onclick = () => {
          currentChannelId = ch.id;
          renderChannels();
          renderMessages();
        };
        list.appendChild(btn);
      });
    }

    function renderMembers() {
      const list = $('#member-list');
      list.innerHTML = '';
      Object.values(allUsers).sort((a,b) => (b.lastSeenAt?.seconds || 0) - (a.lastSeenAt?.seconds || 0)).forEach(u => {
        const isMe = u.id === userProfile.id;
        const isOnline = Date.now() - (u.lastSeenAt?.seconds * 1000 || 0) < 180000;
        const item = document.createElement('div');
        item.className = "flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white/5";
        item.appendChild(createAvatar(u.avatarUrl, u.animals?.[0]));
        item.innerHTML += `
          <div>
            <div class="text-sm font-medium">${u.name} ${u.role==='admin'?'<span class="text-xs bg-red-600 text-white px-1 rounded">ADM</span>':''}</div>
            <div class="text-xs opacity-60">${isMe?'æ‚¨è‡ªå·±':isOnline?'â— ç·šä¸Š':'é›¢ç·š'}</div>
          </div>`;
        list.appendChild(item);
      });
    }

    // ==================== ç™»å…¥ç•«é¢é‚è¼¯ ====================
    document.getElementById('login-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const animals = $$('#animal-selection .selected').map(el => el.textContent);
      const pin = $('#pin-input').value;
      const name = $('#name-input').value;
      if (animals.length !== 3) return alert("è«‹é¸æ“‡ 3 éš»å‹•ç‰©");
      await login(animals, pin, name);
    });

    $$('#animal-grid button').forEach(btn => {
      btn.addEventListener('click', () => {
        const selected = $$('#animal-selection .selected');
        if (selected.length >= 3 && !btn.classList.contains('selected')) return;
        btn.classList.toggle('selected');
        const display = $('#animal-selection');
        display.innerHTML = '';
        $$('#animal-grid .selected').slice(0,3).forEach((b,i) => {
          const span = document.createElement('span');
          span.textContent = b.textContent;
          span.className = "text-4xl";
          display.appendChild(span);
        });
      });
    });

    $('#logout-btn')?.addEventListener('click', () => {
      localStorage.removeItem(`chat_app_animal_id_${appId}`);
      location.reload();
    });
  </script>

  <style>
    body { margin:0; font-family:system-ui,sans-serif; background:#111; color:#eee; min-height:100vh; }
    .hidden { display:none !important; }
    .screen { min-height:100vh; }
    #login-screen { display:flex; align-items:center; justify-content:center; background:#111; }
    .card { background:rgba(0,0,0,0.4); backdrop-filter:blur(16px); border:1px solid rgba(255,255,255,0.1); border-radius:1.5rem; padding:2rem; max-width:420px; width:100%; }
    #animal-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:0.5rem; }
    #animal-grid button { font-size:2rem; padding:1rem; background:rgba(255,255,255,0.05); border-radius:0.75rem; }
    #animal-grid button.selected { background:#d946ef; }
    #chat-screen { display:grid; grid-template-columns:260px 1fr; height:100vh; }
    @media (max-width:768px) { #chat-screen { grid-template-columns:1fr; } }
    #sidebar { background:rgba(0,0,0,0.6); border-right:1px solid rgba(255,255,255,0.1); display:flex; flex-direction:column; }
    #messages { overflow-y:auto; padding:1rem; }
    #input-area { padding:1rem; background:rgba(0,0,0,0.4); border-top:1px solid rgba(255,255,255,0.1); }
    input, button { background:rgba(0,0,0,0.5); border:1px solid rgba(255,255,255,0.1); color:white; border-radius:0.75rem; }
    button:hover { background:rgba(255,255,255,0.1); }
  </style>
</head>
<body>
  <!-- ç™»å…¥ç•«é¢ -->
  <div id="login-screen" class="screen">
    <div class="card">
      <h1 class="text-3xl font-bold text-center mb-6 bg-gradient-to-r from-fuchsia-400 to-purple-400 bg-clip-text text-transparent">ç·šä¸ŠèŠå¤©å®¤</h1>
      <form id="login-form">
        <div class="mb-6">
          <p class="text-center mb-4">è«‹é¸æ“‡ 3 éš»å‹•ç‰©ä½œç‚ºç™»å…¥ ID</p>
          <div id="animal-selection" class="flex justify-center gap-4 text-5xl min-h-[80px] items-center"></div>
          <div id="animal-grid" class="mt-4"></div>
        </div>
        <div class="space-y-4">
          <input type="text" id="pin-input" placeholder="PIN ç¢¼ï¼ˆ4-8ä½æ•¸å­—ï¼‰" maxlength="8" pattern="\d{4,8}" required class="w-full px-4 py-3 text-center text-xl">
          <input type="text" id="name-input" placeholder="æš±ç¨±ï¼ˆé¦–æ¬¡ç™»å…¥å¿…å¡«ï¼‰" class="w-full px-4 py-3 text-center">
          <button type="submit" class="w-full bg-fuchsia-600 hover:bg-fuchsia-500 py-3 rounded-xl font-bold">é€²å…¥èŠå¤©å®¤</button>
        </div>
      </form>
    </div>
  </div>

  <!-- è¢«è¸¢ç•«é¢ -->
  <div id="kicked-screen" class="screen hidden flex flex-col items-center justify-center">
    <h1 class="text-3xl font-bold text-red-500">æ‚¨å·²è¢«æš«æ™‚è¸¢å‡º</h1>
    <p class="mt-4">è§£é–æ™‚é–“ï¼š<span id="kicked-until"></span></p>
    <button onclick="localStorage.clear();location.reload()" class="mt-6 px-6 py-3 bg-gray-800 rounded-xl">è¿”å›</button>
  </div>

  <!-- èŠå¤©å®¤ä¸»ç•«é¢ -->
  <div id="chat-screen" class="screen hidden">
    <div id="sidebar">
      <div class="p-4 border-b border-white/10 flex justify-between items-center">
        <h2 class="font-bold text-fuchsia-500">ç·šä¸ŠèŠå¤©å®¤</h2>
        <button id="logout-btn" class="text-red-500"><i data-lucide="log-out"></i></button>
      </div>
      <div id="channel-list" class="flex-1 overflow-y-auto p-4"></div>
      <div id="member-list" class="p-4 border-t border-white/10"></div>
    </div>
    <div class="flex flex-col">
      <div id="messages" class="flex-1"></div>
      <div id="input-area" class="flex gap-2">
        <input id="message-input" type="text" placeholder="è¼¸å…¥è¨Šæ¯..." class="flex-1 px-4 py-3">
        <button id="send-btn" class="bg-fuchsia-600 hover:bg-fuchsia-500 px-6 rounded-xl"><i data-lucide="send"></i></button>
      </div>
    </div>
  </div>

  <script>
    // å‹•æ…‹ç”¢ç”Ÿå‹•ç‰©æŒ‰éˆ•
    const grid = document.getElementById('animal-grid');
    const animals = ["ğŸ¶","ğŸ±","ğŸ­","ğŸ¹","ğŸ°","ğŸ¦Š","ğŸ»","ğŸ¼","ğŸ¨","ğŸ¯","ğŸ¦","ğŸ®","ğŸ·","ğŸ¸","ğŸµ","ğŸ”","ğŸ§","ğŸ¦","ğŸ¦„","ğŸ™"];
    animals.forEach(a => {
      const btn = document.createElement('button');
      btn.textContent = a;
      grid.appendChild(btn);
    });
    lucide.createIcons();
  </script>
</body>
</html>
