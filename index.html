<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç·šä¸ŠèŠå¤©å®¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans h-screen overflow-hidden">

    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-black/40 backdrop-blur-xl border border-white/10 p-8 rounded-3xl shadow-2xl">
            <h1 id="app-name-display" class="text-3xl font-bold text-center mb-6 bg-gradient-to-r from-fuchsia-400 to-purple-400 bg-clip-text text-transparent">ç·šä¸ŠèŠå¤©å®¤</h1>
            
            <div id="login-step-1">
                <p class="text-gray-400 text-center text-sm mb-6">è«‹é¸æ“‡ 3 å€‹å‹•ç‰©ä½œç‚ºæ‚¨çš„ã€Œç™»å…¥ IDã€</p>
                <div class="flex justify-center gap-4 mb-8">
                    <div class="selected-animal w-16 h-16 rounded-xl bg-white/5 border-2 border-dashed border-white/20 flex items-center justify-center text-3xl"></div>
                    <div class="selected-animal w-16 h-16 rounded-xl bg-white/5 border-2 border-dashed border-white/20 flex items-center justify-center text-3xl"></div>
                    <div class="selected-animal w-16 h-16 rounded-xl bg-white/5 border-2 border-dashed border-white/20 flex items-center justify-center text-3xl"></div>
                </div>
                <div id="animal-grid" class="grid grid-cols-5 gap-2 max-h-48 overflow-y-auto p-2 custom-scrollbar mb-6">
                    </div>
                <button id="btn-next" disabled class="w-full bg-fuchsia-600 hover:bg-fuchsia-500 py-3 rounded-xl font-bold disabled:opacity-50 transition-all">ä¸‹ä¸€æ­¥</button>
            </div>

            <div id="login-step-2" class="hidden">
                <div class="space-y-4">
                    <div id="id-preview" class="text-center text-3xl mb-4"></div>
                    <input type="text" id="login-pin" placeholder="PIN ç¢¼ (4-8ä½æ•¸å­—)" class="w-full bg-black/50 border border-white/10 rounded-xl px-4 py-3 text-center focus:border-fuchsia-500 outline-none">
                    <input type="text" id="login-name" placeholder="æ‚¨çš„æš±ç¨±" class="w-full bg-black/50 border border-white/10 rounded-xl px-4 py-3 text-center focus:border-fuchsia-500 outline-none">
                    <div class="flex gap-2">
                        <button id="btn-back" class="flex-1 bg-gray-700 py-3 rounded-xl">è¿”å›</button>
                        <button id="btn-login" class="flex-[2] bg-fuchsia-600 py-3 rounded-xl font-bold">é€²å…¥</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="chat-screen" class="hidden flex h-screen overflow-hidden relative">
        <aside class="w-64 bg-black/80 backdrop-blur border-r border-white/10 flex flex-col hidden md:flex">
            <div class="p-4 border-b border-white/10 font-bold text-fuchsia-500">èŠå¤©æ§åˆ¶å°</div>
            <div class="flex-1 overflow-y-auto p-2" id="channel-list">
                </div>
            <div class="p-4 border-t border-white/10 bg-black/20">
                <div class="flex items-center gap-3 mb-4">
                    <div id="user-avatar" class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-xl"></div>
                    <div class="overflow-hidden">
                        <div id="user-name-display" class="font-bold text-sm truncate">User</div>
                        <div id="user-id-display" class="text-[10px] text-gray-500">ID: ---</div>
                    </div>
                </div>
                <button id="btn-logout" class="w-full bg-red-900/20 text-red-500 py-2 rounded-lg text-xs hover:bg-red-900/40">ç™»å‡º</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-gray-900">
            <header class="h-16 border-b border-white/10 flex items-center px-4 bg-black/20">
                <span id="current-ch-emoji" class="mr-2 text-xl">ğŸ’¬</span>
                <h2 id="current-ch-name" class="font-bold">ä¸€èˆ¬é–’èŠ</h2>
            </header>
            
            <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                </div>

            <div class="p-4 border-t border-white/10">
                <form id="chat-form" class="flex gap-2 max-w-4xl mx-auto">
                    <input type="text" id="msg-input" placeholder="èªªé»ä»€éº¼..." class="flex-1 bg-black/50 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-fuchsia-500">
                    <button type="submit" class="bg-fuchsia-600 p-3 rounded-xl hover:bg-fuchsia-500 transition-colors">
                        <i data-lucide="send"></i>
                    </button>
                </form>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // --- è¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyBx-TGj56ULPupKwP1YipgQOgyBqwSAnos",
            authDomain: "chatroom-89cc9.firebaseapp.com",
            projectId: "chatroom-89cc9",
            storageBucket: "chatroom-89cc9.firebasestorage.app",
            messagingSenderId: "631226685830",
            appId: "1:631226685830:web:e3d3e0ed3202ff96d6b407"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ANIMALS = ["ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ¨", "ğŸ¯", "ğŸ¦", "ğŸ®", "ğŸ·", "ğŸ¸", "ğŸµ", "ğŸ™", "ğŸ§", "ğŸ¦„"];

        // --- ç‹€æ…‹ ---
        let selectedAnimals = [];
        let currentUserProfile = null;
        let currentChannelId = 'general';

        // --- DOM å…ƒç´  ---
        const ui = {
            login: document.getElementById('login-screen'),
            chat: document.getElementById('chat-screen'),
            animalGrid: document.getElementById('animal-grid'),
            selectedSlots: document.querySelectorAll('.selected-animal'),
            btnNext: document.getElementById('btn-next'),
            btnBack: document.getElementById('btn-back'),
            btnLogin: document.getElementById('btn-login'),
            step1: document.getElementById('login-step-1'),
            step2: document.getElementById('login-step-2'),
            msgContainer: document.getElementById('messages-container'),
            chatForm: document.getElementById('chat-form'),
            msgInput: document.getElementById('msg-input')
        };

        // --- åˆå§‹åŒ–é¸å–® ---
        ANIMALS.forEach(a => {
            const btn = document.createElement('button');
            btn.className = "text-2xl p-2 rounded-xl hover:bg-white/10 transition-all";
            btn.innerText = a;
            btn.onclick = () => {
                if(selectedAnimals.length < 3) {
                    selectedAnimals.push(a);
                    updateAnimalSlots();
                }
            };
            ui.animalGrid.appendChild(btn);
        });

        function updateAnimalSlots() {
            ui.selectedSlots.forEach((slot, i) => {
                slot.innerText = selectedAnimals[i] || "";
                slot.className = selectedAnimals[i] ? "w-16 h-16 rounded-xl bg-fuchsia-600 border-2 border-fuchsia-400 flex items-center justify-center text-3xl" : "w-16 h-16 rounded-xl bg-white/5 border-2 border-dashed border-white/20 flex items-center justify-center text-3xl";
            });
            ui.btnNext.disabled = selectedAnimals.length !== 3;
        }

        ui.btnNext.onclick = () => {
            ui.step1.classList.add('hidden');
            ui.step2.classList.remove('hidden');
            document.getElementById('id-preview').innerText = selectedAnimals.join('');
        };

        ui.btnBack.onclick = () => {
            ui.step1.classList.remove('hidden');
            ui.step2.classList.add('hidden');
        };

        // --- ç™»å…¥é‚è¼¯ ---
        ui.btnLogin.onclick = async () => {
            const pin = document.getElementById('login-pin').value;
            const name = document.getElementById('login-name').value;
            const animalId = selectedAnimals.join('');

            if(pin.length < 4) return alert("PIN ç¢¼å¤ªçŸ­");
            
            try {
                const userRef = doc(db, 'users', animalId);
                const userSnap = await getDoc(userRef);
                
                let uid = auth.currentUser?.uid;
                if(!uid) {
                    const cred = await signInAnonymously(auth);
                    uid = cred.user.uid;
                }

                if(userSnap.exists()) {
                    if(userSnap.data().pin !== pin) return alert("PIN ç¢¼éŒ¯èª¤");
                } else {
                    if(!name) return alert("ç¬¬ä¸€æ¬¡ç™»å…¥è«‹è¼¸å…¥æš±ç¨±");
                    await setDoc(userRef, {
                        name, pin, animalId, animals: selectedAnimals, uid, createdAt: Date.now()
                    });
                }
                
                localStorage.setItem('chat_animal_id', animalId);
                loadChat(animalId);
            } catch (e) { console.error(e); }
        };

        // --- è¼‰å…¥èŠå¤©å®¤ ---
        async function loadChat(animalId) {
            const userSnap = await getDoc(doc(db, 'users', animalId));
            currentUserProfile = userSnap.data();
            
            ui.login.classList.add('hidden');
            ui.chat.classList.remove('hidden');
            document.getElementById('user-name-display').innerText = currentUserProfile.name;
            document.getElementById('user-id-display').innerText = "ID: " + animalId;
            document.getElementById('user-avatar').innerText = currentUserProfile.animals[0];
            
            initMessages();
            lucide.createIcons();
        }

        function initMessages() {
            const q = query(collection(db, 'messages'), orderBy('timestamp', 'asc'));
            onSnapshot(q, (snapshot) => {
                ui.msgContainer.innerHTML = "";
                snapshot.forEach(d => {
                    const msg = d.data();
                    const isMe = msg.senderId === currentUserProfile.animalId;
                    const div = document.createElement('div');
                    div.className = `flex gap-3 ${isMe ? 'flex-row-reverse' : ''}`;
                    div.innerHTML = `
                        <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-sm">${msg.senderAnimal}</div>
                        <div class="max-w-[80%] flex flex-col ${isMe ? 'items-end' : 'items-start'}">
                            <span class="text-[10px] text-gray-500 mb-1">${msg.senderName}</span>
                            <div class="p-3 rounded-2xl text-sm ${isMe ? 'bg-fuchsia-600 rounded-tr-none' : 'bg-gray-800 rounded-tl-none'}">
                                ${msg.text}
                            </div>
                        </div>
                    `;
                    ui.msgContainer.appendChild(div);
                });
                ui.msgContainer.scrollTop = ui.msgContainer.scrollHeight;
            });
        }

        ui.chatForm.onsubmit = async (e) => {
            e.preventDefault();
            const text = ui.msgInput.value.trim();
            if(!text) return;
            
            await addDoc(collection(db, 'messages'), {
                text,
                senderId: currentUserProfile.animalId,
                senderName: currentUserProfile.name,
                senderAnimal: currentUserProfile.animals[0],
                timestamp: Date.now()
            });
            ui.msgInput.value = "";
        };

        document.getElementById('btn-logout').onclick = () => {
            localStorage.removeItem('chat_animal_id');
            location.reload();
        };

        // è‡ªå‹•ç™»å…¥æª¢æŸ¥
        onAuthStateChanged(auth, (user) => {
            const savedId = localStorage.getItem('chat_animal_id');
            if(savedId) loadChat(savedId);
        });

        lucide.createIcons();
    </script>
</body>
</html>
